---
title: "给Waline升级文章阅读量统计功能"
date: 2020-12-17T02:12:13+08:00
draft: true
---

> 作者认为阅读量显示看看量级就好，我仔细想想也确实，升级计划暂时不执行

## 1. 想法

这是目前Waline的阅读量统计功能所依赖的数据结构（数据来自MongoDB）：

> 包括Valine其实也是一样的，顺带一提，Valine现在的文档[https://valine.js.org/visitor.html](https://valine.js.org/visitor.html)上的阅读量是-99893，已经溢出了hhhh

```json
{
    "_id":{
        "$oid": "5fda437080053c00081a3e27"
    },
    "url": "/posts/code/ubuntu-apt-install-go/",
    "time":{
        "$numberInt": "4"
    }
}
```

可以看到这个数据结构非常的简单粗暴，就是用文章的`url`作为计数器的唯一标识，不断累加`time`的值，由于没有其他辅助的记录，Waline实现的功能是每次页面加载时触发JavaScript函数进而触发累加。

这样的阅读数我认为是相当不准的，如果自己手贱刷新几次或者切换一下文章就莫名其妙加了阅读量了，这样的效果让我感觉这样的阅读数并不是非常有参考价值，因此决定自己动手升级一下这个功能。

我个人认为**同一个用户**在**一段时间**内对**同一篇文章**的访问无论如何刷新页面，都应该只属于`1`次访问。

### 1.1 定义同一个用户

由于没有登录系统的支持，无论如何都无法精确定义到一个用户，只能尽量地通过多方面的信息结合判断，其中最为有效的信息就是ip地址，而目前的ipv4状况下一片区域的人都共享1个公网ip地址，单单使用ip地址会将太多的人定义为同一个用户了，因此再配合上`user-agent`来判断会更准确一点点，即用`ip`和`user-agent`定义一个用户。

### 1.2 定义一段时间

结合日常浏览文章来说，只要文章不是特别特别长或者特别晦涩难懂的，一般有个几分钟都够浏览一遍了，因此在这几分钟中应该认为用户的刷新不增加阅读量，具体的数字短的2分钟，长的10分钟，取个中位数6分钟吧，换算成秒就是`300s`。

### 1.3 定义同一篇文章

这个就简单了，用`url`即可。

## 2. 升级原则

保持原有用户的兼容性，不动原有数据结构，只新增数据结构

## 3. 设计思路

### 3.1 前端

由于发起请求时会自动携带上`ip`和`user-agent`，不需要任何修改

### 3.2 后端

#### 3.2.1 存储

由于需要记录每个用户对每个页面的访问时间状况，需要额外引入访问者的存储结构。

Visitor